{"is_source_file": true, "format": "Python", "description": "This file implements authentication-related API endpoints for a FastAPI-based web service, including CSRF token issuance, user login, token refresh, session validation, and logout, along with password hashing and verification functions.", "external_files": ["src.api.errors", "src.db.config", "src.db.service", "src.db.models"], "external_methods": ["get_db", "get_user_by_email", "http_error"], "published": ["hash_password", "verify_password"], "classes": [{"name": "LoginRequest", "description": "Request body model for login containing username/email and password."}, {"name": "LoginResponse", "description": "Response model containing access and refresh tokens after login."}, {"name": "RefreshRequest", "description": "Request body model containing the refresh token for token renewal."}, {"name": "LogoutRequest", "description": "Placeholder model for logout requests (currently empty)."}], "methods": [{"name": "JSONResponse get_csrf_token()", "description": "Issues a CSRF token, sets it as an HttpOnly cookie, and returns it in JSON.", "scope": "", "scopeKind": ""}, {"name": "JSONResponse login( request: Request, payload: LoginRequest, db: Session = Depends(get_db), x_csrf_token: Optional[str] = Header(default=None, convert_underscores=False, alias=\"X-CSRF-Token\"), )", "description": "Authenticates user credentials, issues JWT tokens, and manages CSRF tokens.", "scope": "", "scopeKind": ""}, {"name": "JSONResponse refresh_token(payload: RefreshRequest)", "description": "Validates a refresh token and issues a new access token.", "scope": "", "scopeKind": ""}, {"name": "JSONResponse session_check(authorization: Optional[str] = Header(default=None))", "description": "Checks the validity of the access token and returns user info if valid.", "scope": "", "scopeKind": ""}, {"name": "JSONResponse logout()", "description": "Handles logout requests; here, it simply indicates success and relies on client to discard tokens.", "scope": "", "scopeKind": ""}, {"name": "Optional[User] _ensure_demo_user(db: Session)", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "Tuple[Dict[str,Any],Dict[str,Any]] _issue_token_pair(subject: str, extra_claims: Optional[Dict[str, Any]] = None)", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "str _sign_csrf(value: str)", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "bool _verify_signed_csrf(signed: str)", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "str hash_password(plain: str)", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "bool verify_password(plain: str, password_hash: str)", "scope": "", "scopeKind": "", "description": "unavailable"}], "calls": ["bcrypt.gensalt", "bcrypt.hashpw", "bcrypt.checkpw", "jwt.encode", "jwt.decode", "hmac.new", "hmac.compare_digest", "secrets.token_urlsafe", "os.getenv", "datetime.now", "datetime.timedelta", "datetime.timezone"], "search-terms": ["FastAPI auth endpoints", "JWT token issuance", "CSRF token generation", "Password hashing bcrypt", "Token refresh endpoint"], "state": 2, "file_id": 44, "knowledge_revision": 381, "git_revision": "8bdd86987d6289148d45e8ef53ea535c905d54f0", "revision_history": [{"365": ""}, {"370": "8bdd86987d6289148d45e8ef53ea535c905d54f0"}, {"381": "8bdd86987d6289148d45e8ef53ea535c905d54f0"}], "ctags": [{"_type": "tag", "name": "ACCESS_MIN", "path": "/home/kavia/workspace/code-generation/jira-confluence-connector-146762-146772/integration_backend/src/api/auth.py", "pattern": "/^ACCESS_MIN = int(os.getenv(\"ACCESS_TOKEN_EXPIRES_MIN\", \"15\"))$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "CSRF_COOKIE_NAME", "path": "/home/kavia/workspace/code-generation/jira-confluence-connector-146762-146772/integration_backend/src/api/auth.py", "pattern": "/^CSRF_COOKIE_NAME = os.getenv(\"CSRF_COOKIE_NAME\", \"csrftoken\")$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "CSRF_COOKIE_TTL", "path": "/home/kavia/workspace/code-generation/jira-confluence-connector-146762-146772/integration_backend/src/api/auth.py", "pattern": "/^CSRF_COOKIE_TTL = int(os.getenv(\"CSRF_COOKIE_TTL_SEC\", \"600\"))$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "CSRF_SECRET", "path": "/home/kavia/workspace/code-generation/jira-confluence-connector-146762-146772/integration_backend/src/api/auth.py", "pattern": "/^CSRF_SECRET = os.getenv(\"CSRF_SECRET\") or os.getenv(\"APP_SECRET_KEY\") or os.getenv(\"SECRET_KEY\")/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "DEV_MODE", "path": "/home/kavia/workspace/code-generation/jira-confluence-connector-146762-146772/integration_backend/src/api/auth.py", "pattern": "/^DEV_MODE = str(os.getenv(\"DEV_MODE\", \"false\")).lower() in (\"1\", \"true\", \"yes\")$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "JWT_ALG", "path": "/home/kavia/workspace/code-generation/jira-confluence-connector-146762-146772/integration_backend/src/api/auth.py", "pattern": "/^JWT_ALG = os.getenv(\"ALGORITHM\", \"HS256\")$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "JWT_SECRET", "path": "/home/kavia/workspace/code-generation/jira-confluence-connector-146762-146772/integration_backend/src/api/auth.py", "pattern": "/^JWT_SECRET = os.getenv(\"SECRET_KEY\") or os.getenv(\"APP_SECRET_KEY\") or \"dev-insecure-secret\"$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "LoginRequest", "path": "/home/kavia/workspace/code-generation/jira-confluence-connector-146762-146772/integration_backend/src/api/auth.py", "pattern": "/^class LoginRequest(BaseModel):$/", "language": "Python", "kind": "class"}, {"_type": "tag", "name": "LoginResponse", "path": "/home/kavia/workspace/code-generation/jira-confluence-connector-146762-146772/integration_backend/src/api/auth.py", "pattern": "/^class LoginResponse(BaseModel):$/", "language": "Python", "kind": "class"}, {"_type": "tag", "name": "LogoutRequest", "path": "/home/kavia/workspace/code-generation/jira-confluence-connector-146762-146772/integration_backend/src/api/auth.py", "pattern": "/^class LogoutRequest(BaseModel):$/", "language": "Python", "kind": "class"}, {"_type": "tag", "name": "REFRESH_DAYS", "path": "/home/kavia/workspace/code-generation/jira-confluence-connector-146762-146772/integration_backend/src/api/auth.py", "pattern": "/^REFRESH_DAYS = int(os.getenv(\"REFRESH_TOKEN_EXPIRES_DAYS\", \"7\"))$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "RefreshRequest", "path": "/home/kavia/workspace/code-generation/jira-confluence-connector-146762-146772/integration_backend/src/api/auth.py", "pattern": "/^class RefreshRequest(BaseModel):$/", "language": "Python", "kind": "class"}, {"_type": "tag", "name": "U", "path": "/home/kavia/workspace/code-generation/jira-confluence-connector-146762-146772/integration_backend/src/api/auth.py", "pattern": "/^    from src.db.models import User as U$/", "file": true, "language": "Python", "kind": "unknown", "scope": "_ensure_demo_user", "scopeKind": "function", "nameref": "unknown:User"}, {"_type": "tag", "name": "_ensure_demo_user", "path": "/home/kavia/workspace/code-generation/jira-confluence-connector-146762-146772/integration_backend/src/api/auth.py", "pattern": "/^def _ensure_demo_user(db: Session) -> Optional[User]:$/", "language": "Python", "typeref": "typename:Optional[User]", "kind": "function", "signature": "(db: Session)"}, {"_type": "tag", "name": "_issue_token_pair", "path": "/home/kavia/workspace/code-generation/jira-confluence-connector-146762-146772/integration_backend/src/api/auth.py", "pattern": "/^def _issue_token_pair(subject: str, extra_claims: Optional[Dict[str, Any]] = None) -> Tuple[Dict/", "language": "Python", "typeref": "typename:Tuple[Dict[str,Any],Dict[str,Any]]", "kind": "function", "signature": "(subject: str, extra_claims: Optional[Dict[str, Any]] = None)"}, {"_type": "tag", "name": "_sign_csrf", "path": "/home/kavia/workspace/code-generation/jira-confluence-connector-146762-146772/integration_backend/src/api/auth.py", "pattern": "/^def _sign_csrf(value: str) -> str:$/", "language": "Python", "typeref": "typename:str", "kind": "function", "signature": "(value: str)"}, {"_type": "tag", "name": "_verify_signed_csrf", "path": "/home/kavia/workspace/code-generation/jira-confluence-connector-146762-146772/integration_backend/src/api/auth.py", "pattern": "/^def _verify_signed_csrf(signed: str) -> bool:$/", "language": "Python", "typeref": "typename:bool", "kind": "function", "signature": "(signed: str)"}, {"_type": "tag", "name": "access_token", "path": "/home/kavia/workspace/code-generation/jira-confluence-connector-146762-146772/integration_backend/src/api/auth.py", "pattern": "/^    access_token: str = Field(..., description=\"JWT access token\")$/", "language": "Python", "typeref": "typename:str", "kind": "variable", "scope": "LoginResponse", "scopeKind": "class"}, {"_type": "tag", "name": "email", "path": "/home/kavia/workspace/code-generation/jira-confluence-connector-146762-146772/integration_backend/src/api/auth.py", "pattern": "/^    email: Optional[str] = Field(None, description=\"Email address\")$/", "language": "Python", "typeref": "typename:Optional[str]", "kind": "variable", "scope": "LoginRequest", "scopeKind": "class"}, {"_type": "tag", "name": "expires_in", "path": "/home/kavia/workspace/code-generation/jira-confluence-connector-146762-146772/integration_backend/src/api/auth.py", "pattern": "/^    expires_in: int = Field(..., description=\"Access token expiry in seconds\")$/", "language": "Python", "typeref": "typename:int", "kind": "variable", "scope": "LoginResponse", "scopeKind": "class"}, {"_type": "tag", "name": "get_csrf_token", "path": "/home/kavia/workspace/code-generation/jira-confluence-connector-146762-146772/integration_backend/src/api/auth.py", "pattern": "/^def get_csrf_token() -> JSONResponse:$/", "language": "Python", "typeref": "typename:JSONResponse", "kind": "function", "signature": "()"}, {"_type": "tag", "name": "hash_password", "path": "/home/kavia/workspace/code-generation/jira-confluence-connector-146762-146772/integration_backend/src/api/auth.py", "pattern": "/^def hash_password(plain: str) -> str:$/", "language": "Python", "typeref": "typename:str", "kind": "function", "signature": "(plain: str)"}, {"_type": "tag", "name": "login", "path": "/home/kavia/workspace/code-generation/jira-confluence-connector-146762-146772/integration_backend/src/api/auth.py", "pattern": "/^def login($/", "language": "Python", "typeref": "typename:JSONResponse", "kind": "function", "signature": "( request: Request, payload: LoginRequest, db: Session = Depends(get_db), x_csrf_token: Optional[str] = Header(default=None, convert_underscores=False, alias=\"X-CSRF-Token\"), )"}, {"_type": "tag", "name": "logout", "path": "/home/kavia/workspace/code-generation/jira-confluence-connector-146762-146772/integration_backend/src/api/auth.py", "pattern": "/^def logout() -> JSONResponse:$/", "language": "Python", "typeref": "typename:JSONResponse", "kind": "function", "signature": "()"}, {"_type": "tag", "name": "password", "path": "/home/kavia/workspace/code-generation/jira-confluence-connector-146762-146772/integration_backend/src/api/auth.py", "pattern": "/^    password: str = Field(..., description=\"Plaintext password\")$/", "language": "Python", "typeref": "typename:str", "kind": "variable", "scope": "LoginRequest", "scopeKind": "class"}, {"_type": "tag", "name": "refresh_token", "path": "/home/kavia/workspace/code-generation/jira-confluence-connector-146762-146772/integration_backend/src/api/auth.py", "pattern": "/^    refresh_token: str = Field(..., description=\"JWT refresh token\")$/", "language": "Python", "typeref": "typename:str", "kind": "variable", "scope": "LoginResponse", "scopeKind": "class"}, {"_type": "tag", "name": "refresh_token", "path": "/home/kavia/workspace/code-generation/jira-confluence-connector-146762-146772/integration_backend/src/api/auth.py", "pattern": "/^    refresh_token: str = Field(..., description=\"Refresh token JWT\")$/", "language": "Python", "typeref": "typename:str", "kind": "variable", "scope": "RefreshRequest", "scopeKind": "class"}, {"_type": "tag", "name": "refresh_token", "path": "/home/kavia/workspace/code-generation/jira-confluence-connector-146762-146772/integration_backend/src/api/auth.py", "pattern": "/^def refresh_token(payload: RefreshRequest) -> JSONResponse:$/", "language": "Python", "typeref": "typename:JSONResponse", "kind": "function", "signature": "(payload: RefreshRequest)"}, {"_type": "tag", "name": "router", "path": "/home/kavia/workspace/code-generation/jira-confluence-connector-146762-146772/integration_backend/src/api/auth.py", "pattern": "/^router = APIRouter(tags=[\"Auth\"])$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "session_check", "path": "/home/kavia/workspace/code-generation/jira-confluence-connector-146762-146772/integration_backend/src/api/auth.py", "pattern": "/^def session_check(authorization: Optional[str] = Header(default=None)) -> JSONResponse:$/", "language": "Python", "typeref": "typename:JSONResponse", "kind": "function", "signature": "(authorization: Optional[str] = Header(default=None))"}, {"_type": "tag", "name": "token_type", "path": "/home/kavia/workspace/code-generation/jira-confluence-connector-146762-146772/integration_backend/src/api/auth.py", "pattern": "/^    token_type: str = Field(default=\"bearer\", description=\"Token type\")$/", "language": "Python", "typeref": "typename:str", "kind": "variable", "scope": "LoginResponse", "scopeKind": "class"}, {"_type": "tag", "name": "username", "path": "/home/kavia/workspace/code-generation/jira-confluence-connector-146762-146772/integration_backend/src/api/auth.py", "pattern": "/^    username: Optional[str] = Field(None, description=\"Username or email\")$/", "language": "Python", "typeref": "typename:Optional[str]", "kind": "variable", "scope": "LoginRequest", "scopeKind": "class"}, {"_type": "tag", "name": "verify_password", "path": "/home/kavia/workspace/code-generation/jira-confluence-connector-146762-146772/integration_backend/src/api/auth.py", "pattern": "/^def verify_password(plain: str, password_hash: str) -> bool:$/", "language": "Python", "typeref": "typename:bool", "kind": "function", "signature": "(plain: str, password_hash: str)"}], "hash": "9a369ea4cfb1cffe100cbbdc8f651f2a", "format-version": 4, "code-base-name": "integration_backend", "filename": "integration_backend/src/api/auth.py", "fields": [{"name": "ACCESS_MIN = int(os.getenv(\"ACCESS_TOKEN_EXPIRES_MIN\", \"15\"))", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "CSRF_COOKIE_NAME = os.getenv(\"CSRF_COOKIE_NAME\", \"csrftoken\")", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "CSRF_COOKIE_TTL = int(os.getenv(\"CSRF_COOKIE_TTL_SEC\", \"600\"))", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "CSRF_SECRET = os.getenv(\"CSRF_SECRET\") or os.getenv(\"APP_SECRET_KEY\") or os.getenv(\"SECRET_KEY\")/", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "DEV_MODE = str(os.getenv(\"DEV_MODE\", \"false\")).lower() in (\"1\", \"true\", \"yes\")", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "JWT_ALG = os.getenv(\"ALGORITHM\", \"HS256\")", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "JWT_SECRET = os.getenv(\"SECRET_KEY\") or os.getenv(\"APP_SECRET_KEY\") or \"dev-insecure-secret\"", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "REFRESH_DAYS = int(os.getenv(\"REFRESH_TOKEN_EXPIRES_DAYS\", \"7\"))", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "str access_token", "scope": "LoginResponse", "scopeKind": "class", "description": "unavailable"}, {"name": "Optional[str] email", "scope": "LoginRequest", "scopeKind": "class", "description": "unavailable"}, {"name": "int expires_in", "scope": "LoginResponse", "scopeKind": "class", "description": "unavailable"}, {"name": "str password", "scope": "LoginRequest", "scopeKind": "class", "description": "unavailable"}, {"name": "str refresh_token", "scope": "LoginResponse", "scopeKind": "class", "description": "unavailable"}, {"name": "router = APIRouter(tags=[\"Auth\"])", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "str token_type", "scope": "LoginResponse", "scopeKind": "class", "description": "unavailable"}, {"name": "Optional[str] username", "scope": "LoginRequest", "scopeKind": "class", "description": "unavailable"}]}